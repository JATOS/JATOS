@(signedinUser: common.User, breadcrumbs: String)(body: Html)

<!DOCTYPE html>

<html lang="en">
<head>
    <title>JATOS</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="shortcut icon" type="image/png" href="@routes.Assets.versioned("/favicon-96x96.png")" sizes="96x96">
    <link rel="shortcut icon" type="image/png" href="@routes.Assets.versioned("/favicon-16x16.png")" sizes="16x16">
    <link rel="shortcut icon" type="image/png" href="@routes.Assets.versioned("/favicon-32x32.png")" sizes="32x32">
    <link rel="stylesheet" href="@routes.Assets.versioned("lib/jatos-gui/bootstrap-5.3.2/bootstrap.min.css")">
    <link rel="stylesheet" href="@routes.Assets.versioned("lib/jatos-gui/bootstrap-icons-1.11.2/font/bootstrap-icons.min.css")">
    <link rel="stylesheet" href="@routes.Assets.versioned("lib/jatos-gui/DataTables/datatables.min.css")">
    <link rel="stylesheet" href="@routes.Assets.versioned("lib/jatos-gui/stylesheets/main.css?v=" + general.common.Common.getJatosVersion())">
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/javascripts/jquery-3.5.1.min.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/showdown-1.9.0/showdown.min.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/ace-1.4.2/ace.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/bootstrap-5.3.2/bootstrap.bundle.min.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/DataTables/datatables.min.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/javascripts/easy.qrcode.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/javascripts/timeago.min.js")"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/javascripts/fileSystemAccess.js")" type="module"></script>
    <script @{helper.CSPNonce.attr} src="@routes.Assets.versioned("lib/jatos-gui/javascripts/colorModeToggler.js")"></script>
    @if(signedinUser.isOauthGoogle()) {
    <script @{helper.CSPNonce.attr} src="https://accounts.google.com/gsi/client" async defer></script>
    }
</head>

<script @{helper.CSPNonce.attr}>

    function showSuccessToast(msg) {
        showToast(msg, "success");
    }

    function showInfoToast(msg) {
        showToast(msg, "info");
    }

    function showWarningToast(msg) {
        showToast(msg, "warning");
    }

    function showErrorToast(msg) {
        showToast(msg, "error");
    }

    function showToast(msg, type = "info") {
        let icon, headerText, textColor;
        switch (type) {
            case "success":
                icon = 'bi-check-circle-fill';
                headerText = "Success";
                textColor = "success";
                break;
            case "info":
                icon = 'bi-info-circle-fill';
                headerText = "Info";
                textColor = "info";
                break;
            case "warning":
                icon = 'bi-exclamation-triangle-fill';
                headerText = "Warning";
                textColor = "warning";
                break;
            case "danger":
            case "error":
                icon = 'bi-exclamation-octagon-fill';
                headerText = "Error";
                textColor = "danger";
                break;
        }
        const html = `<div class="toast" data-bs-autohide="false">
                <div class="toast-header text-bg-${textColor}">
                <i class="${icon} pe-1"></i>
                <strong class="me-auto">${headerText}</strong>
                <small class="timeago" datetime="${new Date().toISOString()}"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${msg}</div>
                </div>`;
        $(".toast-container").append(html);
        const toastElement = $(".toast").last();
        timeago.render(toastElement.find(".timeago").get());
        (new bootstrap.Toast(toastElement)).show();
    }

    function showSuccess(msg, insertAfterElem, allowHtml = false) {
        showToast(msg, "success");
    }

    function showInfo(msg, insertAfterElem, allowHtml = false) {
        showToast(msg, "info");
    }

    function showWarning(msg, insertAfterElem, allowHtml = false) {
        showToast(msg, "warning");
    }

    function showError(msg, insertAfterElem, allowHtml = false) {
        showToast(msg, "error");
    }

    function showAlert(msg, type = "info", insertAfterElem, allowHtml = false) {
        msg = allowHtml ? msg : $($.parseHTML(msg)).text();
        let icon;
        switch (type) {
            case "success":
                icon = 'bi-check-circle-fill';
                break;
            case "info":
                icon = 'bi-info-circle-fill';
                break;
            case "warning":
                icon = 'bi-exclamation-triangle-fill';
                break;
            case "danger":
                icon = 'bi-exclamation-octagon-fill';
                break;
            default:
                icon = 'bi-info-circle-fill';
        }
        const html = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="${icon}"></i>
                <span>${msg}</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`;
        if (insertAfterElem) {
            $(html).insertAfter(insertAfterElem);
        } else {
            $(html).insertAfter("#breadcrumbs");
        }
        $('.alert').click(function(event) {
            if (!$(this).is("a")) $(this).remove();
        });
    }

    function removeAlerts(elem) {
        if (elem) {
            $(elem).find(".alert").remove();
        } else {
            $('#breadcrumbs').nextAll('.alert').remove();
        }
    }

    function showFormErrors(formElem, response) {
        if (response.responseJSON) {
            var errors = response.responseJSON;
            $.each(errors, function(key, errorArray) {
                $.each(errorArray, function(index, msg) {
                    showSingleFormError(formElem + " ." + key, msg)
                });
            });
        }
    }

    function showModalError(formElem, response) {
        if (response.responseText) {
            showError(response.responseText, formElem);
        }
    }

    function showSingleFormError(selector, msg) {
        $(selector).closest(".form-group").addClass("has-error");
        $(selector).after('<span class="help-block">' + $($.parseHTML(msg)).text() + '</span>');
    }

    function removeFormErrors(elem) {
        $(elem).find("*").removeClass("has-error");
        $(elem).find(".help-block").remove();
    }

    function removeSingleFormError(selector) {
        $(selector).closest(".form-group").removeClass("has-error");
        $(selector).nextAll(".help-block").remove();
    }

    function clearForm(formElem) {
        $(formElem + " input[type=text], input[type=number], input[type=password], textarea").val("");
        $(formElem + " input[type=checkbox]").removeAttr('checked');
        $(formElem + " input[type=radio]").removeAttr('selected');
    }

    // Adjust the width of every button to the widest one
    function setButtonWidthToMax(element) {
        var maxWidth = 0;
        $(element).each(function(index) {
            var width = $(this).width();
            if (width > maxWidth) {
                maxWidth = width;
            }
        });
        $(element).each(function(index) {
            $(this).width(maxWidth);
        });
    }

    function isJson(string) {
        try {
            $.parseJSON(string);
            return true;
        } catch(error) {
            return false;
        }
    }

    function getUIWorkerTypeWithGlyphicon(workerType) {
        switch (workerType) {
        case "@common.workers.JatosWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-jatos"></span> @common.workers.JatosWorker.UI_WORKER_TYPE</span>';
        case "@common.workers.PersonalSingleWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-personal-single"></span> @common.workers.PersonalSingleWorker.UI_WORKER_TYPE</span>';
        case "@common.workers.PersonalMultipleWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-personal-multiple"></span> @common.workers.PersonalMultipleWorker.UI_WORKER_TYPE</span>';
        case "@common.workers.GeneralSingleWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-general-single"></span> @common.workers.GeneralSingleWorker.UI_WORKER_TYPE</span>';
        case "@common.workers.GeneralMultipleWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-general-multiple"></span> @common.workers.GeneralMultipleWorker.UI_WORKER_TYPE</span>';
        case "@common.workers.MTSandboxWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-mturk-sandbox"></span> @common.workers.MTSandboxWorker.UI_WORKER_TYPE</span>';
        case "@common.workers.MTWorker.WORKER_TYPE":
            return '<span class="noWrap"><span class="glyphicon glyphicon-mturk"></span> @common.workers.MTWorker.UI_WORKER_TYPE</span>';
        default:
            return "unknown";
        }
    }

    function isLocalhost() {
        return location.hostname === 'localhost' ||
        location.hostname === '' ||
        location.hostname === '[::1]' ||
        location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/);
    }

    function getAuthMethodText(authMethod) {
        switch(authMethod) {
            case "DB": return "local";
            case "LDAP": return "LDAP";
            case "OAUTH_GOOGLE": return "Google";
            case "OIDC": return "OIDC";
            case "ORCID": return "ORCID";
            default: return authMethod;
        }
    }

    function generateOrcidLink(orcid) {
        return `<a href="https://orcid.org/${orcid}" target="_blank" class="text-nowrap"><img alt="ORCID logo" src="@routes.Assets.versioned("lib/jatos-gui/images/ORCIDiD_iconvector.svg")" width="16" height="16" />&nbsp;${orcid}</a>`;
    }

    function generateFullUserString(name, username, authMethod) {
        if (authMethod == "ORCID") {
            return `${name} (${generateOrcidLink(username)})`;
        } else {
            return `${name} (${username})`;
        }
    }

    function trimTextWithThreeDots(text, length) {
         return text.length > length ? text.substring(0, length - 3) + "..." : text;
    }
</script>

<body class="container-fluid d-flex flex-column vh-100 overflow-hidden p-0">

    <header class="navbar navbar-expand-lg sticky-top p-0 bg-body-tertiary flex-md-nowrap">
        <div class="d-flex">
            <button class="nav-link d-flex d-lg-none px-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar">
                <i class="bi-list"></i>
            </button>
        </div>
        <a class="navbar-brand ps-lg-2 me-0 me-lg-2" href="@controllers.gui.routes.Home.home()">
            <svg xmlns="http://www.w3.org/2000/svg" width="49" height="32" class="d-block my-1" viewBox="0 0 400 261" xml:space="preserve" role="img">
                <title>JATOS</title>
                <path class="jatos-logo" fill="#FDCD08" stroke="#F9B517" stroke-width="2" stroke-miterlimit="10" d="M357.887,72.484 c-15.67,15.667-41.07,15.667-56.739,0c-15.67-15.667-15.666-41.066,0.004-56.733c15.665-15.67,41.065-15.668,56.731-0.003 C373.551,31.416,373.551,56.819,357.887,72.484z"/>
                <path class="jatos-logo" fill="#FDCD08" stroke="#F9B517" stroke-width="2" stroke-miterlimit="10" d="M192.113,116.582 c-4.421,3.64-11.165-2.84-18.446-11.689l0,0c-7.283-8.846-12.349-16.711-7.924-20.354l65.759-54.132 c4.424-3.64,11.173,2.84,18.453,11.689l0,0c7.286,8.847,12.349,16.709,7.926,20.352L192.113,116.582z"/>
                <path class="jatos-logo" fill="#F4921F" d="M157.837,143.812c-20.586,5.752-30.277,8.31-40.333-3.909c-10.06-12.22,28.426,11.635,14.717-27.208 c-4.798-13.602,19.472-21.436,29.53-9.214C171.807,115.695,168.869,140.732,157.837,143.812z"/>
                <path class="jatos-logo" fill="#FDCD08" stroke="#F9B517" stroke-width="2" stroke-miterlimit="10" d="M226.694,160.292 c-5.279,5.275-14.02,0.886-22.128-7.22l0,0c-8.105-8.102-12.5-16.852-7.222-22.128l76.108-76.104 c5.279-5.28,102.479-12.649,121.845-7.802l1.978,3.848c-4.349,20.936-89.199,28.021-94.476,33.298L226.694,160.292z"/>
                <path class="jatos-logo" fill="#FDCD08" stroke="#F9B517" stroke-width="2" stroke-miterlimit="10" d="M175.909,150.907 c5.278-5.279,14.02-0.884,22.126,7.218l0,0c8.107,8.105,12.499,16.85,7.223,22.131l-76.109,76.1 c-5.279,5.281-102.481-3.949-121.848-8.795l-1.977-3.85c4.348-20.936,89.2-11.422,94.479-16.697L175.909,150.907z"/>
            </svg>
        </a>
        <div class="d-flex">
            <button class="navbar-toggler d-flex d-lg-none border border-0 shadow-none px-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarMenu">
                <i class="bi-three-dots"></i>
            </button>
        </div>
        <div class="offcanvas-lg offcanvas-end flex-grow-1" id="navbarMenu" tabindex="-1" data-bs-scroll="true">
            <div class="offcanvas-header px-4 pb-0">
                <h5 class="offcanvas-title" id="navbarMenuOffcanvasLabel">JATOS</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#navbarMenu"></button>
            </div>
            <div class="offcanvas-body p-4 pt-0 p-lg-0 align-items-center">
                <hr class="d-lg-none">
                <ul class="navbar-nav flex-row flex-wrap">
                    <li class="nav-item col-6 col-lg-auto" data-bs-toggle="tooltip" data-bs-title="Create a new study">
                        <button class="nav-link py-2 px-0 px-lg-3" id="createStudyLink"><i class="bi-plus-lg pe-1"></i>New Study</button>
                    </li>
                    <li class="d-none"><input id="importStudyBrowser" type="file" name="study"></li>
                    <li class="nav-item col-6 col-lg-auto" data-bs-toggle="tooltip" data-bs-title="Import a study from the local file system">
                        <button id="importStudyLink" class="nav-link py-2 px-0 px-lg-3"><i class="bi-box-arrow-in-down-right pe-1"></i>Import Study</button>
                    </li>
                    @if(signedinUser.isAdmin()) {
                    <li class="nav-item col-6 col-lg-auto" data-bs-toggle="tooltip" data-bs-title="Everything for admins">
                        <a class="nav-link py-2 px-0 px-lg-3" href="@controllers.gui.routes.Admin.administration()"><i class="bi-gear-fill pe-1"></i>Administration</a>
                    </li>
                    }
                </ul>
                <hr class="d-lg-none">
                <ul class="navbar-nav flex-row flex-wrap col-auto ms-auto align-items-center">
                    <li class="nav-item col-6 col-lg-auto">
                        <a class="nav-link" href="https://www.jatos.org/Whats-JATOS.html" target="_blank"><i class="bi-file-text"></i><span class="ps-1 d-lg-none">Docs</span></a>
                    </li>
                    <li class="nav-item col-6 col-lg-auto">
                        <a class="nav-link" href="https://www.github.com/JATOS/JATOS" target="_blank"><i class="bi-github"></i><span class="ps-1 d-lg-none">GitHub</span></a>
                    </li>
                    <li class="nav-item col-6 col-lg-auto">
                        <a class="nav-link" href="https://opencollective.com/" target="_blank"><i class="bi-opencollective"></i><span class="ps-1 d-lg-none">Open Collective</span></a>
                    </li>
                    <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
                        <div class="vr d-none d-lg-flex h-100 mx-lg-2"></div>
                        <hr class="d-lg-none my-2">
                    </li>
                    <li class="nav-item dropdown" id="navUser">
                        <a class="nav-link dropdown-toggle px-0 px-lg-2 d-flex align-items-center" type="button" data-bs-toggle="dropdown" data-bs-display="static">
                            <span class="pe-1" id="navbarUsername">@signedinUser.getName()</span>
                            <img class="rounded-circle border border-2 p-0" id="userImg" src="" width="32" height="32" alt="thumbnail">
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" data-bs-popper="static">
                            <li class="dropdown-header"></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a id="navUserText" class="dropdown-item d-flex align-items-center" href="@controllers.gui.routes.Users.profile(signedinUser.getUsername())">
                                    <i class="bi-gear-fill pe-1"></i>My settings
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center" href="@{general.common.Common.getJatosUrlBasePath()}jatos/signout">
                                    <i class="bi-door-closed pe-1"></i>Sign out
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item py-2 py-lg-1 col-12 col-lg-auto">
                        <div class="vr d-none d-lg-flex h-100 mx-lg-2"></div>
                        <hr class="d-lg-none my-2">
                    </li>
                    <li class="nav-item dropdown" id="colorTheme">
                        <button class="nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown" data-bs-display="static">
                            <span class="pe-1 theme-icon-active"><i class="bi-sun-fill"></i></span>
                            <span id="colorThemeText" class="d-lg-none">Toggle theme</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" data-bs-popper="static">
                            <li>
                                <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light">
                                    <span class="me-2 theme-icon"><i class="bi-sun-fill"></i></span>
                                    Light
                                    <i class="bi-check2 ms-auto d-none"></i>
                                </button>
                            </li>
                            <li>
                                <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark">
                                    <span class="me-2 theme-icon"><i class="bi-moon-stars-fill"></i></span>
                                    Dark
                                    <i class="bi-check2 ms-auto d-none"></i>
                                </button>
                            </li>
                            <li>
                                <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto">
                                    <span class="me-2 theme-icon"><i class="bi-circle-half"></i></span>
                                    Auto
                                    <i class="bi-check2 ms-auto d-none"></i>
                                </button>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="row overflow-hidden g-0">

        <div class="col-lg-2 mh-100 overflow-auto p-0 border border-right bg-body-tertiary">
            <div class="offcanvas-lg offcanvas-start" tabindex="-1" id="sidebar" data-bs-scroll="true">
                <div class="offcanvas-header px-4 pb-0">
                    <h5 class="offcanvas-title" id="sidebarLabel">Studies</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebar"></button>
                </div>
                <div class="offcanvas-body p-0">
                    <hr class="d-lg-none">
                    <div class="list-group list-group-flush border-bottom overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <main class="col mh-100 overflow-auto p-3">

            <nav id="breadcrumbs">
                <ol class="breadcrumb rounded-3 p-3 bg-body-tertiary"></ol>
            </nav>

            <div class="bg-body-secondary position-sticky rounded-3">
                <div class="toast-container top-0 end-0 p-3">
                </div>
            </div>

            @************ Here goes the actual page template ************@
            @body

        </main>
    </div>

    <!-- Confirmation  Modal -->
    <div class="modal fade" id="confirmationModal" data-backdrop="static" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Confirm</h4>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="confirmed btn"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Waiting modal -->
    <div class="modal fade" id="waitingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><img src="@routes.Assets.versioned("lib/jatos-gui/images/waiting.gif")">Working</h4>
                </div>
                <div class="modal-body">
                    ... might take a while depending on your internet connection and the JATOS server ... please be patient.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</body>

@views.html.gui.auth.signinModal(signedinUser)
@views.html.gui.study.studyImportModal()
@views.html.gui.study.studyPropertiesModal()

<script @{helper.CSPNonce.attr}>
    var version = "@{general.common.Common.getJatosVersion()}";

    // Needed for Bootstrap (Popper) tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    var waitingModalTimeout;
    var messagesRequestScope = @Html(general.gui.RequestScopeMessaging.getAsJson());
    showMessages(messagesRequestScope);
    var messagesFlashScope = @Html(general.gui.FlashScopeMessaging.getAsJson());
    showMessages(messagesFlashScope);
    fillSidebar();

    // Notify user of localhost installation
    if(isLocalhost()) {
        $(".navbar-brand img").attr("src", "@routes.Assets.versioned("lib/jatos-gui/images/jatos_logo_grey.svg")");
    }

    $("#navUser .dropdown-header").html(`
            <h6 class="mb-0">${trimTextWithThreeDots("@signedinUser.getUsername()", 20)} (${trimTextWithThreeDots("@signedinUser.getName()", 20)})</h6>
            <span class="fw-light">Signed in with your ${getAuthMethodText("@signedinUser.getAuthMethod()")} account</span>
    `);

    // Fill breadcrumbs
    (function() {
        var breadcrumbs = @Html(breadcrumbs);
        $.each(breadcrumbs, function(index, breadcrumb) {
            var breadcrumbHtml;
            if (breadcrumb.url === null || breadcrumb.url === "") {
                breadcrumbHtml = `<li class="breadcrumb-item active">${breadcrumb.name}</li>`;
            } else {
                breadcrumbHtml = `<li class="breadcrumb-item"><a href="${breadcrumb.url}">${breadcrumb.name}</a></li>`;
            }
            $("#breadcrumbs ol").append(breadcrumbHtml);
        });
    })()

    function showWaitingModal(cancelable) {
        clearTimeout(waitingModalTimeout);
        if (typeof cancelable === 'boolean' && cancelable === true) {
            $('#waitingModal .modal-footer').show();
        } else {
            $('#waitingModal .modal-footer').hide();
        }
        waitingModalTimeout = setTimeout(function() { $('#waitingModal').modal('show') }, 2000);
    }

    function hideWaitingModal() {
        clearTimeout(waitingModalTimeout);
        $('#waitingModal').modal('hide');
    }

    $('#waitingModal').on('click', '.cancel', function (e) {
        window.abortFileDownload();
        hideWaitingModal();
    });

    function showMessages(messages, allowHtml = false) {
        if (messages != null) {
            if (messages.successList != null) messages.successList.forEach(function(msg) { showSuccessToast(msg) });
            if (messages.infoList != null) messages.infoList.forEach(function(msg) { showInfoToast(msg) });
            if (messages.warningList != null) messages.warningList.forEach(function(msg) { showWarningToast(msg) });
            if (messages.errorList != null) messages.errorList.forEach(function(msg) { showErrorToast(msg) });
        }
    }

    function askConfirmation(title, html, buttonText, buttonClass, action) {
        $('#confirmationModal .modal-title').text(title);
        if (html) {
            $('#confirmationModal .modal-body').html(html);
        }
        $('#confirmationModal .confirmed').text(buttonText);
        $('#confirmationModal .confirmed').addClass(buttonClass);
        $('#confirmationModal').modal('show');
        $('#confirmationModal').off('click.confirm').on('click.confirm', '.confirmed', function() {
            $('#confirmationModal').modal('hide');
            $('#confirmationModal .confirmed').removeClass(buttonClass);
            action();
        });
    }

    function fillSidebar() {
        $.ajax({
            type: 'GET',
            url: '@controllers.gui.routes.Home.sidebarData()',
            success: function(result) {
                drawSidebar(result);
            },
            error : function(err) {
                showErrorToast(err.responseText);
            }
        });
    }

    $('#sidebarStudyList').on('click', '.studyListItem', function(e) {
        // If chevron clicked show study's components
        if ($(e.target).hasClass('glyphicon-chevron-right')
                || $(e.target).hasClass('glyphicon-chevron-down')) {
            $(this).find(".glyphicon-chevron-right, .glyphicon-chevron-down").toggleClass('study-expanded study-collapsed');
            $(this).find(".glyphicon-chevron-right, .glyphicon-chevron-down").toggleClass('glyphicon-chevron-right glyphicon-chevron-down');
        } else {
            var clickedStudyId = $(this).attr('id').replace('sidebarStudy', "");
            window.location.href = '@{general.common.Common.getJatosUrlBasePath()}jatos/' + clickedStudyId;
        }
    });

    function drawSidebar(studyArray) {
        $('#sidebar .list-group').empty();

        studyArray.forEach((study) => {
            const html = `
                    <a class="list-group-item list-group-item-action py-3 ps-4 ps-lg-3 lh-sm" href="@{general.common.Common.getJatosUrlBasePath()}jatos/${study.id}">
                        <div class="d-flex w-100 align-items-center justify-content-between">
                            <strong class="mb-1">${study.title}</strong>
                            <div class="text-nowrap">
                                <span class="badge bg-secondary rounded-pill"><i class="bi-lock-fill"></i></span>
                                <span class="badge bg-secondary rounded-pill"><i class="bi-people-fill"></i></span>
                            </div>
                        </div>
                        <div class="mb-1 fs-6">${study.uuid}</div>
                    </a>`;
            $("#sidebar .list-group").append(html);
        });
    }

    $(document).on('show.bs.modal', '.modal', function() {
        var zIndex = 1040 + (10 * $('.modal:visible').length);
        $(this).css('z-index', zIndex);
        setTimeout(function() {
            $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
        }, 0);
    });

    function getDateTimeYYYYMMDDHHmmss() {
        return new Date().toISOString().replaceAll(/\.\d{3}Z/g, "").replaceAll(/[:\-T\.]/g, "");
    }

    function getFormattedDate(timestamp) {
        // From https://stackoverflow.com/a/67705873/1278769
        // Uses format YYYY/MM/DD HH:mm:ss
        const pad = (n,s=2) => (`${new Array(s).fill(0)}${n}`).slice(-s);
        const d = new Date(timestamp);
        return `${pad(d.getFullYear(),4)}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function copyToClipboard(textToCopy) {
        // navigator clipboard api needs a secure context (https)
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(textToCopy);
        } else {
            window.prompt("Copy to clipboard: Ctrl+C, Enter", textToCopy);
        }
    }

    /**
     * Returns the request's host URL without path (and without base path from Common.getJatosUrlBasePath()) or query string
     * (e.g. just "https://www.example.com"). It returns the URL with the proper protocol http or https.
     */
    function getRealHostUrl() {
        return location.protocol + '//' + location.host;
    }

    /**
     * Returns the request's host URL with base path from Common.getJatosUrlBasePath() but without the rest of the path
     * or query string (e.g. "https://www.example.com/basepath/"). It returns the URL with the proper protocol http
     * or https.
     */
    function getRealBaseUrl() {
        return location.protocol + '//' + location.host + '@general.common.Common.getJatosUrlBasePath()';
    }

    async function digestMessage(message) {
        const msgUint8 = new TextEncoder().encode(message); // encode as (utf-8) Uint8Array
        const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8); // hash the message
        const hashArray = Array.from(new Uint8Array(hashBuffer)); // convert buffer to byte array
        const hashHex = hashArray
                .map((b) => b.toString(16).padStart(2, "0"))
                .join(""); // convert bytes to hex string
        return hashHex;
    }

    (() => {
        $('#userImg').one(); // Ignore imgage loading errors

        const googlePictureUrl = document.cookie.split("; ").find((row) => row.startsWith("G_PIC_URL="))?.split("=")[1];
        if (googlePictureUrl) {
            $('#userImg').attr("src", googlePictureUrl);
        } else {
            const signedinUserEmail = "@signedinUser.getEmail()".toLowerCase().trim();
            const signedinUserUsername = "@signedinUser.getUsername()".toLowerCase().trim();
            const email = signedinUserEmail ? signedinUserEmail : (signedinUserUsername ? signedinUserUsername : null);
            if (!email) return;

            digestMessage(email).then((hash) => {
                $('#userImg').attr("src", `https://gravatar.com/avatar/${hash}?size=32&d=robohash`);
            });
        }
    })();

</script>
</html>
