@(signedinUser: common.User, breadcrumbs: String, study: common.Study, studyResultsCount: Integer)
@import controllers.gui.routes._
@import general.common._

@views.html.gui.main_new(signedinUser, Some(study), breadcrumbs) {

<main class="container-xxl overflow-auto mt-4">

    @* Study toolbar *@
    <div class="sticky-top pb-4 text-nowrap flex-wrap" id="studyToolbar" role="toolbar">
            <a class="btn btn-study no-info-icon" id="runStudy" href="#" type="button" data-toggle="tooltip" title="Do a test run of your study">
                <i class="bi-play-circle"></i><span class="d-none d-xl-inline ps-1">Run</span>
            </a>
            <button class="btn btn-study" id="studyResults" type="button" data-toggle="tooltip" title="Show this study's results">
                <span class="d-none d-xl-inline">Study </span>Results<span class="badge text-study bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results of this study">@studyResultsCount</span>
            </button>
            <button class="btn btn-study" id="studyProperties" type="button" data-bs-toggle="modal" data-bs-target="#studyPropertiesModal" data-toggle="tooltip" title="Change this study's properties">
                <i class="bi-gear-fill"></i><span class="d-none d-xl-inline ps-1">Properties</span>
            </button>
            <button class="btn btn-study" id="exportStudy" type="button" data-toggle="tooltip" title="Export this study to your local file system (including its components and study assets but without its results)">
                <i class="bi-box-arrow-up-right"></i><span class="d-none d-xl-inline ps-1">Export</span>
            </button>
            <button class="btn btn-study" id="lockStudy" type="button" data-toggle="tooltip" data-placement="bottom" title="">
                <i class="bi-unlock-fill"></i>
            </button>
            <button class="btn btn-study" type="button" data-bs-toggle="offcanvas" data-bs-target="#studyDescriptionSidebar" data-toggle="tooltip" title="The description of this study like defined in the study properties">
                <i class="bi-file-text-fill"></i><span class="d-none d-xl-inline ps-1">Description</span>
            </button>
            <div class="btn-group me-3" role="group">
                <button class="btn btn-study dropdown-toggle" type="button" data-bs-toggle="dropdown" data-toggle="tooltip" title="More options">
                    <i class="bi-three-dots-vertical d-xl-none"></i><span class="d-none d-xl-inline ps-1">More</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-study">
                    <li class="no-info-icon" data-toggle="tooltip" title="Clone this study without its results">
                        <a class="dropdown-item" id="cloneStudy" href="#"><i class="bi-copy pe-1"></i>Clone</a>
                    </li>
                    <li class="no-info-icon" data-toggle="tooltip" title="Change which users can access this study">
                        <a class="dropdown-item" data-bs-toggle="modal" href="#studyMemberUsersModal"><i class="bi-people-fill pe-1"></i>Change Users</a>
                    </li>
                    <li class="no-info-icon" data-toggle="tooltip" title="Show this study's study log">
                        <a class="dropdown-item" data-bs-toggle="modal" href="#studyLogModal"><i class="bi-journal-text pe-1"></i>Study Log</a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="no-info-icon" data-toggle="tooltip" title="Delete this study including its components, assets and results">
                        <a class="dropdown-item" id="removeStudy" href="#"><i class="bi-x-circle-fill pe-1"></i>Delete</a>
                    </li>
                </ul>
            </div>
            <button class="btn btn-component me-3" data-bs-toggle="modal" data-bs-target="#createComponentModal" type="button" data-toggle="tooltip" title="Add a new component">
                <i class="bi-plus-lg fw-bold"></i><span class="d-none d-xl-inline ps-1">New Component</span>
            </button>
            <button class="btn btn-batch" id="studyLinksButton" type="button" data-toggle="tooltip" title="Get study links that you can distribute to your participants and let them run your study">
                <i class="bi-link-45deg"></i><span class="d-none d-xl-inline ps-1">Study Links</span>
            </button>
    </div>

    @views.html.gui.study.components_new(study)

</main>
}

@views.html.gui.study.studyPropertiesModal_new(study)
@views.html.gui.study.studyDescription_new(study)
@views.html.gui.study.studyMemberUsersModal_new(signedinUser, study)
@views.html.gui.study.componentPropertiesModal_new(study)
@views.html.gui.study.studyLogModal_new(study)

<script @{helper.CSPNonce.attr} type="module">
    import * as Alerts from "@routes.Assets.versioned("lib/jatos-gui/javascripts/alerts.js")";
    import * as Helpers from "@routes.Assets.versioned("lib/jatos-gui/javascripts/helpers.js")";
    import * as ConfirmationModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/confirmationModal.js")";
    import * as WaitingModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/waitingModal.js")";
    import * as FileSystemAccess from "@routes.Assets.versioned("lib/jatos-gui/javascripts/fileSystemAccess.js")";

    drawLockButton();

    $('#lockStudy').click(function() {
        $.ajax({
            url : window.routes.Studies.toggleLock(window.study.id),
            type : "POST",
            success : function(response) {
                window.study.isLocked = response === 'true';
                drawLockButton();

            },
            error : function(err) {
                Alerts.error(err.responseText);
            }
        });
    });

    function drawLockButton() {
        if (window.study.isLocked) {
            $('#lockStudy').html('<i class="bi-lock-fill"></i>');
            $('#lockStudy').removeClass('btn-study').addClass('btn-warning');
            $("#lockStudy").attr("title", "Press to unlock this study and allow changes.");
        } else {
            $('#lockStudy').html('<i class="bi-unlock-fill"></i>');
            $('#lockStudy').removeClass('btn-warning').addClass('btn-study');
            $("#lockStudy").attr("title", "Press to lock this study and prohibit changes. Your study links will still work.");
        }
    }

    // Set the href property in code so users can use the Ctrl + click to open the study run in a different tab
    $('#runStudy').prop("href", `${window.routes.Studies.runStudy(window.study.id)}`);

    $('#studyResults').click(function() {
        window.location.href = window.routes.StudyResults.studysStudyResults(window.study.id);
    });

    $('#studyLinksButton').click(function() {
        window.location.href = window.routes.StudyLinks.studyLinks(window.study.id);
    });

    $('#exportStudy').click(function() {
        const url = window.routes.Api.exportStudy(window.study.id);
        const filename = '@{study.getTitle()}.jzip';
        FileSystemAccess.downloadFileStream(url, null, filename);
    });

    $('#removeStudy').click(function() {
        const title = `Confirm Deletion of study "${window.study.title}"`;
        const htmlText = `<p>You are about to delete the study "<b>${window.study.title}" (ID ${window.study.id})
            with all its components, results, and the entire study assets directory</b>.</p>
            <p><b class="text-danger">This cannot be undone.</b></p>`;
        const action = function() {
            $.ajax({
                url : window.routes.Api.deleteStudy(window.study.id),
                type : 'DELETE',
                beforeSend: WaitingModal.show,
                success : function(result) {
                    window.location.replace(window.routes.Home.home);
                },
                error : function(err) {
                    Alerts.error(err.responseText);
                },
                complete: WaitingModal.hide
            });
        };
        ConfirmationModal.show({ title: title, text: htmlText, btnText: 'Delete', safetyCheck: true, action: action });
    });

    $('#cloneStudy').click(function() {
        $.ajax({
            url : window.routes.Studies.cloneStudy(window.study.id),
            success : function(response) {
                Alerts.success(`Created clone "${response.title}". <a href="${window.routes.Studies.study(response.id)}">Go to this study.</a>`);
                StudySidebar.draw();
            },
            error : function(err) {
                Alerts.error(err.responseText);
            }
        });
    });
</script>