@(signedinUser: common.User, breadcrumbs: String, study: common.Study, request: Http.Request)

@views.html.gui.main_new(signedinUser, Some(study), breadcrumbs) {

<main class="container-xxl overflow-auto mt-4">

    @* Toolbar *@
    <div class="d-flex gap-1 mb-4" id="studyLinksToolbar">
        <button class="btn btn-batch" id="createBatchButton" type="button" data-bs-toggle="modal" data-bs-target="#createBatchModal" data-toggle="tooltip" title="Add a new batch of workers">
            <i class="bi-plus-lg fw-bold"></i><span class="d-none d-sm-inline ps-1">New Batch</span>
        </button>
        <button class="btn btn-batch" id="studyLinksCreatorGeneralButton" type="button" data-toggle="tooltip" title="Shortcut to get study links for the different worker types and batches. Study links are meant to be distributed to your participants so they can run the study.">
            <i class="bi-link-45deg"></i><span class="d-none d-sm-inline ps-1">Get Study Links</span>
        </button>
    </div>

    @* Create Batch Modal *@
    <div class="modal fade" id="createBatchModal" tabindex="-1" data-bs-config='{"backdrop":"static", "focus":true, "keyboard":false}'>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add a new batch</h5>
                    <button type="button" class="btn btn-close btn-nav" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form class="form-batch" id="createBatchForm">
                        <div class="row">
                            <label class="col-sm-3 col-form-label" for="createBatchTitle">
                                Title<span class="input-required" data-toggle="tooltip" title="required"></span>
                            </label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="createBatchTitle" name="title" placeholder="Your batch title" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-batch" id="createBatchConfirmed">Add</button>
                </div>
            </div>
        </div>
    </div>

    @* Batch Table *@
    <table class="table table-hover w-100" id="batchTable">
        <thead>
        <tr>
            <th></th>
            <th class="no-info-icon" data-toggle="tooltip" title="Activate / inactivate batches - study links from inactivated batches won't run">Active<span class="info-icon"></span><span class="ordering-icon"></span></th>
            <th class="no-info-icon" data-toggle="tooltip" title="ID of this batch">ID<span class="info-icon"></span><span class="ordering-icon"></span></th>
            <th class="no-info-icon" data-toggle="tooltip" title="Title of this batch">Batch title<span class="info-icon"></span><span class="ordering-icon"></span></th>
            <th></th>
        </tr>
        </thead>
    </table>

    @* Template for button toolbar in batch's row *@
    <div class="d-none" id="batchToolbarTemplate" >
        <div class="float-end text-nowrap">
            <button class="batch-properties btn btn-batch" type="button" data-toggle="tooltip" title="Change this batch's properties">
                <i class="bi-gear-fill"></i><span class="d-none d-xl-inline ps-1">Properties</span>
            </button>
            <button class="batch-session btn btn-batch" type="button" data-toggle="tooltip" title="See and edit this batch's session data">
                <i class="bi-list-columns-reverse"></i><span class="d-none d-xl-inline ps-1">Batch Session Data</span>
            </button>
            <button class="batch-results btn btn-batch" type="button" data-toggle="tooltip" title="Show only the study results that belong to this batch">
                <span class="d-none d-xl-inline">Batch </span>Results
                <span class="badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results that belong to this batch"></span>
            </button>
            <button class="groups btn btn-batch" type="button" data-toggle="tooltip" title="Show all groups of this batch">
                <i class="bi-people-fill"></i><span class="d-none d-xl-inline ps-1">Groups</span>
                <span class="badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of groups in this batch"></span>
            </button>
            <div class="btn-group" role="group">
                <button class="btn btn-batch dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi-three-dots-vertical d-lg-none"></i><span class="d-none d-xl-inline ps-1">More</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-batch">
                    <li class="no-info-icon" data-toggle="tooltip" title="Delete this batch">
                        <a class="dropdown-item remove-batch" href="#"><i class="bi-x-circle-fill pe-1"></i>Delete</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    @views.html.gui.studyLinks.batchPropertiesModal_new(study)
    @views.html.gui.studyLinks.sessionModal_new(study)
    @views.html.gui.studyLinks.groupsModal_new(study)
    @views.html.gui.studyLinks.studyLinksSetup_new(signedinUser, study)
    @views.html.gui.studyLinks.studyLinksManager_new(signedinUser, study)
    @views.html.gui.studyLinks.qrCodeModal_new()
    @views.html.gui.studyLinks.studyLinksCreator_new()
@views.html.gui.studyLinks.studyLinksCreatorGeneralModal(study)
@views.html.gui.studyLinks.mTurkSourceCodeModal(study, request)

</main>

<script @{helper.CSPNonce.attr} type="module">
    import * as Helpers from "@routes.Assets.versioned("lib/jatos-gui/javascripts/helpers.js")";
    import * as Alerts from "@routes.Assets.versioned("lib/jatos-gui/javascripts/alerts.js")";
    import * as FormValidation from "@routes.Assets.versioned("lib/jatos-gui/javascripts/formValidation.js")";
    import * as ConfirmationModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/confirmationModal.js")";
    import * as WaitingModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/waitingModal.js")";

    const alerts = new Alerts.Named("study-links");
    $("#createBatchModal").on('hide.bs.modal', alerts.hideAll);

    let batchTable;
    $(document).ready(function() {
        batchTable = $('#batchTable').DataTable({
            "ajax": {
                "url" : window.routes.StudyLinks.batchesByStudy(window.study.id),
                "error": () => Alerts.error("Error reading result data")
            },
            "dom": 't',
            "pageLength": 100,
            "order": [[ 2, "asc" ]],
            "scrollX": true,
            "rowId": 'id',
            "columns": [
                {
                    "class": 'details-control',
                    "data": null,
                    "orderable": false,
                    "render": function (data, type, full, meta) {
                        return `<button type="button" class="btn btn-batch text-nowrap collapse-study-links-setup dropdown-toggle px-3"
                            data-toggle="tooltip" title="Open/close this batch"></button>`;
                    }
                },
                {
                    "className": 'batch-active align-middle',
                    "data": "active",
                    "orderable": true,
                    "render": function (data, type, full, meta) {
                        if (type === 'export' || type === 'sort') return data.toString();
                        return `
                            <label class="switch no-info-icon" data-toggle="tooltip" title="Use this switch to de-/activate this batch. In a deactivated batch study links belonging to this batch will not work.">
                                <input type="checkbox" ${data ? "checked" : ""}>
                                <span class="slider slider-batch round"></span>
                            </label>
                        `;
                    }
                },
                {
                    "className": "batch-id align-middle text-nowrap",
                    "data": "id",
                    "type": "num",
                    "orderable": true
                },
                {
                    "className": "batch-title align-middle text-nowrap",
                    "data": "title",
                    "orderable": true
                },
                {
                    "class": "toolbar",
                    "data": null,
                    "orderable": false,
                    "render": function (data, type, full, meta) {
                        const toolbar = $('#batchToolbarTemplate').clone().show();
                        $(toolbar).find('.groups .badge').text(data.groupCount);
                        $(toolbar).find('.batch-results .badge').text(data.resultCount);
                        return toolbar.html();
                    }
                }
            ],
            "createdRow": function(row, data, index) {
                $(row).addClass("batch-row");
                if (!window.study.isGroupStudy) {
                    $(row).find('.groups').attr('disabled', true);
                }
            },
            "drawCallback": function( settings ) {
                Helpers.setButtonWidthToMax("#batchTable .batchResultsButton");
                Helpers.setButtonWidthToMax("#batchTable .groupsButton");
            },
            "initComplete": function( settings, json ) {
                $(".collapse-study-links-setup")[0].click();
            }
        });
    });

    $("#createBatchModal").on('show.bs.modal', function() {
        $("#createBatchForm")[0].reset();
        FormValidation.clear("#createBatchForm");
    });

    $("#createBatchConfirmed").click(function(event) {
        $.ajax({
            type: 'POST',
            url: window.routes.StudyLinks.submitCreatedBatch(window.study.id),
            data: $('#createBatchForm').serialize(),
            success: function(response) {
                $('#createBatchModal').modal('hide');
                batchTable.ajax.reload();
            },
            error: function(response) {
                FormValidation.clear("#createBatchForm");
                alerts.warning("The batch was not added.", 5000);
                if (Helpers.isJson(response.responseText)) {
                    FormValidation.show("#createBatchForm", response.responseJSON);
                } else {
                    alerts.error(response.responseText);
                }
            }
        });
    });

    $('#batchTable').on('click', '.batch-active input', function(e) {
        e.preventDefault();
        const checkbox = this;
        const isActive = $(checkbox).is(':checked');
        const tr = $(this).closest('tr');
        const batch = batchTable.row(tr).data();
        $.ajax({
            url: window.routes.StudyLinks.toggleBatchActive(window.study.id, batch.id, isActive),
            type: "POST",
            success: function(active) {
                $(checkbox).prop('checked', isActive);
                batch.active = isActive;
            },
            error: function(err) {
                Alerts.error(err.responseText);
            }
        });
    });

    $('#batchTable').on('click', '.batch-results', function() {
        const batch = getBatchData(this);
        window.location.href = window.routes.StudyResults.batchesStudyResults(window.study.id, batch.id);
    });

    $('#batchTable').on('click', '.remove-batch', function() {
        const element = this;
        const batch = getBatchData(this);
        const title = `Confirm Deletion of batch "${batch.title}"`;
        const htmlText = `<p>You are about to delete the batch "<b>${batch.title}" (ID ${batch.id}) with all its results</b>.</p>
            <p><b class="text-danger">This cannot be undone.</b></p>`;
        const action = () => {
            $.ajax({
                url : window.routes.StudyLinks.removeBatch(window.study.id, batch.id),
                type : 'DELETE',
                beforeSend: WaitingModal.show,
                success : function(result) {
                    Alerts.showList(JSON.parse(result));
                    batchTable.ajax.reload();
                },
                error : function(err) {
                    Alerts.error(err.responseText);
                },
                complete: WaitingModal.hide
            });
        };
        ConfirmationModal.show({ title: title, text: htmlText, btnText: 'Delete', safetyCheck: true, action: action });
    });

    function getBatchData(element) {
        const batchRow = $(element).closest('tr');
        return batchTable.row(batchRow).data();
    }

</script>

}
