@(signedinUser: common.User, study: common.Study)

@* Template study links setup (each batch has one) *@
<div class="d-none" id="studyLinksSetupTemplate">
    <div class="collapse study-links-setup-item m-2 mx-5">

        <div class="study-links-setup d-flex align-items-center mb-2" data-type="PersonalSingle">
            <label class="switch no-info-icon" data-toggle="tooltip" title="Use this switch to de-/activate this type. Study links from deactivated types will not work.">
                <input class="active-type" type="checkbox">
                <span class="slider slider-batch round"></span>
            </label>
            <div class="flex-grow-1 mx-3" data-toggle="tooltip" title="Study links with the worker type Personal Single can run a study only once. They are typically used to be distributed amongst participants that you contact individually. Each link can be personalized with a comment.">Personal Single</div>
            <div class="text-nowrap float-end">
                <button class="btn btn-batch study-links-manager" type="button" data-toggle="tooltip" title="Show existing and create new study links for the worker type Personal Single">
                    <span class="d-none d-xl-inline">Study </span>Links<span class="study-links-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of existing study links for this type"></span>
                </button>
                <button class="btn btn-batch worker-results-button" type="button" data-toggle="tooltip" title="Show all study results that belong to this batch and worker type Personal Single">
                    Results<span class="worker-results-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results that belong to this batch and worker type Personal Single"></span>
                </button>
            </div>
        </div>

        <div class="study-links-setup d-flex align-items-center mb-2" data-type="PersonalMultiple">
            <label class="switch no-info-icon" data-toggle="tooltip" title="Use this switch to de-/activate this type. Study links from deactivated types will not work.">
                <input class="active-type" type="checkbox">
                <span class="slider slider-batch round"></span>
            </label>
            <div class="flex-grow-1 mx-3" data-toggle="tooltip" title="Study links with the worker type Personal Multiple can run a study multiple times. They are typically used to be distributed amongst participants that you contact individually. Each link can be personalized with a comment.">Personal Multiple</div>
            <div class="text-nowrap float-end">
                <button class="btn btn-batch study-links-manager" type="button" data-toggle="tooltip" title="Show existing and create new study links for the worker type Personal Multiple">
                    <span class="d-none d-xl-inline">Study </span>Links<span class="study-links-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of existing study links for this type"></span>
                </button>
                <button class="btn btn-batch worker-results-button" type="button" data-toggle="tooltip" title="Show all study results that belong to this batch and worker type Personal Multiple">
                    Results<span class="worker-results-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results that belong to this batch and worker type Personal Multiple"></span>
                </button>
            </div>
        </div>

        <div class="study-links-setup d-flex align-items-center mb-2" data-type="GeneralSingle">
            <label class="switch no-info-icon" data-toggle="tooltip" title="Use this switch to de-/activate this type. Study links from deactivated types will not work.">
                <input class="active-type" type="checkbox">
                <span class="slider slider-batch round"></span>
            </label>
            <div class="flex-grow-1 mx-3" data-toggle="tooltip" title="Study links with the worker type General Single can be used many times - but only once in the same browser. There is only one link of this type per batch. They are typically used to be distributed in a mailing list or posting in social media.">General Single</div>
            <div class="text-nowrap float-end">
                <button class="btn btn-batch study-links-manager" type="button" data-toggle="tooltip" title="Show existing and create new study links for the worker type General Single">
                    <span class="d-none d-xl-inline">Study </span>Link<span class="study-links-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of existing study links for this type"></span>
                </button>
                <button class="btn btn-batch worker-results-button" type="button" data-toggle="tooltip" title="Show all study results that belong to this batch and worker type General Single">
                    Results<span class="worker-results-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results that belong to this batch and worker type General Single"></span>
                </button>
            </div>
        </div>

        <div class="study-links-setup d-flex align-items-center mb-2" data-type="GeneralMultiple">
            <label class="switch no-info-icon" data-toggle="tooltip" title="Use this switch to de-/activate this type. Study links from deactivated types will not work.">
                <input class="active-type" type="checkbox">
                <span class="slider slider-batch round"></span>
            </label>
            <div class="flex-grow-1 mx-3" data-toggle="tooltip" title="Study links with the worker type General Multiple can be used many times - even in the same browser. There is only one link of this type per batch. They are typically used to be distributed in a mailing list or posting in social media.">General Multiple</div>
            <div class="text-nowrap float-end">
                <button class="btn btn-batch study-links-manager" type="button" data-toggle="tooltip" title="Show existing and create new study links for the worker type General Multiple">
                    <span class="d-none d-xl-inline">Study </span>Link<span class="study-links-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of existing study links for this type"></span>
                </button>
                <button class="btn btn-batch worker-results-button" type="button" data-toggle="tooltip" title="Show all study results that belong to this batch and worker type General Multiple">
                    Results<span class="worker-results-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results that belong to this batch and worker type General Multiple"></span>
                </button>
            </div>
        </div>

        <div class="study-links-setup d-flex align-items-center" data-type="MT">
            <label class="switch no-info-icon" data-toggle="tooltip" title="Use this switch to de-/activate this type. Study links from deactivated types will not work.">
                <input class="active-type" type="checkbox">
                <span class="slider slider-batch round"></span>
            </label>
            <div class="flex-grow-1 mx-3" data-toggle="tooltip" title="MTurk workers do not have a study link they have source code that contains the study link. This source code has to be copied into the 'source' field of your study's design layout in Mechanical Turk.">MTurk</div>
            <div class="text-nowrap float-end">
                <button class="btn btn-batch mt-source-code" type="button" data-toggle="tooltip" title="Show code that has to be copied into the 'source' field of your study's design layout in Mechanical Turk">
                    <span class="d-none d-xl-inline">Source </span>Code
                </button>
                <button class="btn btn-batch worker-results-button" type="button" data-toggle="tooltip" title="Show all study results that belong to this batch and worker type MTurk">
                    Results<span class="worker-results-badge badge text-batch bg-white rounded-pill no-info-icon ms-1" data-toggle="tooltip" title="Number of study results that belong to this batch and worker type MTurk"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script @{helper.CSPNonce.attr} type="module">
    import * as Helpers from "@routes.Assets.versioned("lib/jatos-gui/javascripts/helpers.js")";
    import * as Alerts from "@routes.Assets.versioned("lib/jatos-gui/javascripts/alerts.js")";
    import * as WaitingModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/waitingModal.js")";

    $('#batchTable').on('click', 'td.details-control', function() {
        const tr = $(this).closest('tr');
        const row = $("#batchTable").DataTable().row(tr);
        if (row.child.isShown()) {
            const collapseElement = row.child().find(".collapse");
            // First we collapse with Bootstrap and then we hide the DataTable row
            collapseElement.off('hidden.bs.collapse').on('hidden.bs.collapse', row.child.hide);
            new bootstrap.Collapse(collapseElement).hide();
        } else {
            var batch = row.data();
            $.ajax({
                url: window.routes.StudyLinks.studyLinksSetupData(window.study.id, batch.id),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
            }).done(function(studyLinksSetupData) {
                const studyLinksSetupDiv = $('#studyLinksSetupTemplate .study-links-setup-item').clone();
                // We first show the DataTables row and then de-collapse with Bootstrap
                row.child(studyLinksSetupDiv).show(); // Let DataTables add the child row. But it's still collapsed.
                fillStudyLinksSetup(studyLinksSetupData, studyLinksSetupDiv);
                tr.next().addClass('info').find("td:first").addClass("p-0");
                const collapseElement = row.child().find(".collapse");
                new bootstrap.Collapse(collapseElement).show();
            }).fail(function(err) {
                Alerts.error("Couldn't load study links setup.");
            }).always(WaitingModal.hide);
        }
    });

    function fillStudyLinksSetup(studyLinksSetupData, studyLinksSetupDiv) {
        setAllowedWorkerTypes(studyLinksSetupDiv, studyLinksSetupData.allowedWorkerTypes);

        $(studyLinksSetupDiv).find('.study-links-setup[data-type="PersonalSingle"] .study-links-badge').text(studyLinksSetupData.personalSingleLinkCount);
        $(studyLinksSetupDiv).find('.study-links-setup[data-type="PersonalMultiple"] .study-links-badge').text(studyLinksSetupData.personalMultipleLinkCount);

        let resultCount = studyLinksSetupData.studyResultCountsPerWorker.PersonalSingle;
        $(studyLinksSetupDiv).find('.study-links-setup[data-type="PersonalSingle"] .worker-results-badge').text(resultCount);
        resultCount = studyLinksSetupData.studyResultCountsPerWorker.PersonalMultiple;
        $(studyLinksSetupDiv).find('.study-links-setup[data-type="PersonalMultiple"] .worker-results-button .worker-results-badge').text(resultCount);
        resultCount = studyLinksSetupData.studyResultCountsPerWorker.GeneralSingle;
        $(studyLinksSetupDiv).find('.study-links-setup[data-type="GeneralSingle"] .worker-results-button .worker-results-badge').text(resultCount);
        resultCount = studyLinksSetupData.studyResultCountsPerWorker.GeneralMultiple;
        $(studyLinksSetupDiv).find('.study-links-setup[data-type="GeneralMultiple"] .worker-results-button .worker-results-badge').text(resultCount);
        resultCount = studyLinksSetupData.studyResultCountsPerWorker.MT + studyLinksSetupData.studyResultCountsPerWorker.MTSandbox;
        $(studyLinksSetupDiv).find('.study-links-setup[data-type="MT"] .worker-results-button .worker-results-badge').text(resultCount);

        //Helpers.setButtonWidthToMax(".study-links-setup-item .study-links-manager");
        //Helpers.setButtonWidthToMax(".study-links-setup-item .worker-results-button");
    }

    function setAllowedWorkerTypes(studyLinksSetupDiv, allowedWorkerTypes) {
        // First clear all allowed worker types
        $(studyLinksSetupDiv).find(".active-type").each(function(index) {
            $(this).prop('checked', false);
        });
        // Now set the allowed ones
        $.each(allowedWorkerTypes, function(index, workerType) {
            switch (workerType) {
            case 'PersonalSingle':
                $(studyLinksSetupDiv).find('.study-links-setup[data-type="PersonalSingle"] .active-type').prop('checked', true);
                break;
            case 'PersonalMultiple':
                $(studyLinksSetupDiv).find('.study-links-setup[data-type="PersonalMultiple"] .active-type').prop('checked', true);
                break;
            case 'GeneralSingle':
                $(studyLinksSetupDiv).find('.study-links-setup[data-type="GeneralSingle"] .active-type').prop('checked', true);
                break;
            case 'GeneralMultiple':
                $(studyLinksSetupDiv).find('.study-links-setup[data-type="GeneralMultiple"] .active-type').prop('checked', true);
                break;
            case 'MT':
                $(studyLinksSetupDiv).find('.study-links-setup[data-type="MT"] .active-type').prop('checked', true);
                break;
            }
        });
    }

    $('#batchTable').on('click', '.active-type', function(e) {
        e.preventDefault();
        const checkbox = this;
        const workerType = $(checkbox).parents(".study-links-setup").data("type");
        const allow = $(checkbox).is(':checked');
        const batch = getBatchData(checkbox);
        const studyLinksSetupDiv = $(checkbox).closest('.study-links-setup-item');
        $.ajax({
            url: window.routes.StudyLinks.toggleAllowedWorkerType(window.study.id, batch.id, workerType, allow),
            type : "POST",
            success: function(allowedWorkerTypes) {
                batch.allowedWorkerTypes = allowedWorkerTypes;
                setAllowedWorkerTypes(studyLinksSetupDiv, allowedWorkerTypes);
            },
            error : function(err) {
                Alerts.error("Couldn't change worker type activation.");
            }
        });
    });

$('#batchTable').on('click', '.worker-results-button', function() {
    var workerType = $(this).data("type");
    var batch = getBatchData(this);
    if (workerType) {
        window.location.href =  "@{general.common.Common.getJatosUrlBasePath()}jatos/@study.getId()/batch/" + batch.id
            + "/results?workerType=" + workerType;
    }
});

function setStudyLinkRowActive(button, active, studyResultState) {
    if (active) {
        button.addClass('activeStudyLink');
        button.removeClass('btn-default');
        button.addClass('btn-worker');
        button.attr('title', "Click to deactivate this study link");
        button.children(".glyphicon").removeClass('glyphicon-remove').addClass('glyphicon-ok');
        button.children(".searchText").text("active");
    } else {
        button.removeClass('activeStudyLink');
        button.removeClass('btn-worker');
        button.addClass('btn-default');
        button.attr('title', "Click to activate this study link");
        button.children(".glyphicon").removeClass('glyphicon-ok').addClass('glyphicon-remove');
        button.children(".searchText").text("deactivated");
    }
    const isPersonalSingle = $('#studyLinksModal').data('workerType') == "@common.workers.PersonalSingleWorker.WORKER_TYPE";
    if (isPersonalSingle && studyResultState !== null && studyResultState !== "PRE") {
        button.prop("disabled", true);
        button.attr('title', "This link was already used and can't be deactivated.");
        button.addClass("grayout");
        button.children(".searchText").text("used");
    }
}

$('#studyLinksModal').on('click', '.activeStudyLinkButton', function() {
    var button = this;
    var batch = $('#studyLinksModal').data('batch');
    var active = $(button).hasClass('activeStudyLink');
    var tr = $(button).closest('tr');
    var rowData = studyLinksTable.row(tr).data();
    var studyCode = rowData.studyCode;
    $.ajax({
        url : "@{general.common.Common.getJatosUrlBasePath()}jatos/" + @study.getId() +"/batch/" + batch.id
                + "/studyLink/" + studyCode + "?active=" + !active,
        type : "POST",
        success: function(active) {
            setStudyLinkRowActive($(button), active, rowData.studyResultState);
        },
        error : function(err) {
            showError(err.responseText);
        }
    });
});

$('#studyLinksModal').on('click', '.refreshButton', function(e) {
    $("#studyLinksModal .refreshButton").prop('disabled', true);
    studyLinksTable.ajax.reload();
    setTimeout(() => $("#studyLinksModal .refreshButton").prop('disabled', false), 3000);
});

$('#studyLinksModal').on('click', '.oneNewStudyLinkButton', function(e) {
    const batch = $('#studyLinksModal').data('batch');
    const workerType = $('#studyLinksModal').data('workerType');
    $.ajax({
        url: `@{general.common.Common.getJatosUrlBasePath()}jatos/api/v1/studies/@study.getId()/studyCodes?batchId=${batch.id}&type=${workerType}`,
        success: () => studyLinksTable.ajax.reload(),
        error : (err) => showError(err.responseText)
    });
});

$('#studyLinksModal').on('click', '.newStudyLinksButton', function(e) {
    var batch = $('#studyLinksModal').data('batch');
    var workerType = $('#studyLinksModal').data('workerType');
    if (workerType == "@common.workers.PersonalSingleWorker.WORKER_TYPE") {
        showStudyLinksManagerPersonalSingleModal(batch);
    } else if (workerType == "@common.workers.PersonalMultipleWorker.WORKER_TYPE") {
        showStudyLinksManagerPersonalMultipleModal(batch)
    }
});

function showStudyLinksManagerPersonalSingleModal(batch) {
    var text = "Use a comment to distinguish these study links from others.";
    var title = "Create study links for worker type Personal Single in batch '" + batch.title + "'";
    showStudyLinksManagerModal(title, text);
    $('#studyLinksManagerModal').off('click.confirm').on('click.confirm', '.confirmed', function() {
        const url = `@{general.common.Common.getJatosUrlBasePath()}jatos/api/v1/studies/@study.getId()/studyCodes?batchId=${batch.id}&type=PersonalSingle`;
        requestLinksPersonal(url, showStudyLinksDisplayPersonalModal, batch);
    });
}

function showStudyLinksManagerPersonalMultipleModal(batch) {
    var text = "Use a comment to distinguish these study links from others.";
    var title = "Create study links for worker type Personal Multiple in batch '" + batch.title + "'";
    showStudyLinksManagerModal(title, text);
    $('#studyLinksManagerModal').off('click.confirm').on('click.confirm', '.confirmed', function() {
        var url = `@{general.common.Common.getJatosUrlBasePath()}jatos/api/v1/studies/@study.getId()/studyCodes?batchId=${batch.id}&type=PersonalMultiple`;
        requestLinksPersonal(url, showStudyLinksDisplayPersonalModal, batch);
    });
}

function showStudyLinksManagerModal(title, text) {
    $('#studyLinksManagerModal').find('.modal-title').html(title);
    $('#studyLinksManagerModal').find('.alert').remove();
    $('#studyLinksManagerModal').find('.modalText').html(text);
    $('#studyLinksManagerModal').find('.comment').val("");
    $('#studyLinksManagerModal').find('.amount').val(1);
    // Focus on comment input field in modal
    $('#studyLinksManagerModal').on('shown.bs.modal', function () {
        $('#studyLinksManagerModal').find('.comment').focus();
    })
    $('#studyLinksManagerModal').modal('show');
}

function requestLinksPersonal(url, studyLinksDisplayModal, batch) {
    const comment = encodeURIComponent($('#studyLinksManagerModal').find('.comment').val());
    const amount = $('#studyLinksManagerModal').find('.amount').val();
    $('#studyLinksManagerModal').find('.alert').remove();
    $.ajax({
        url: `${url}&comment=${comment}&amount=${amount}`,
        success: function(studyCodesResponse) {
            $('#studyLinksManagerModal').modal('hide');
            if (studyLinksTable) {
                loadStudyLinksSetup(batch.id);
                studyLinksTable.ajax.reload();
            }
            studyLinksDisplayModal(studyCodesResponse.data, batch);
        },
        error : function(err) {
            showError(err.responseText, "#studyLinksManagerModal .messages");
        }
    });
}

function showStudyLinksDisplayPersonalModal(studyCodes, batch) {
    var title;
    var workerType = $('#studyLinksModal').data('workerType');
    var workerTypeUI;
    if (workerType == "@common.workers.PersonalSingleWorker.WORKER_TYPE") {
        title = `Study links for Personal Single workers in batch '${batch.title}'`;
        workerTypeUI = "@common.workers.PersonalSingleWorker.UI_WORKER_TYPE";
    } else if (workerType == "@common.workers.PersonalMultipleWorker.WORKER_TYPE") {
        title = `Study links for Personal Multiple workers in batch '${batch.title}'`;
        workerTypeUI = "@common.workers.PersonalMultipleWorker.UI_WORKER_TYPE";
    }
    var preText, postText;
    if (studyCodes.length == 1) {
        preText = `<div class="directLink">This link will start the study directly.</div>
            <div class="confirmLink">This link will start the study but first ask the worker for confirmation (by pressing a button).</div>`;
        postText = `Or use the study code '${studyCodes[0]}'.<br>Copy & paste and hand it to your worker.`;
    } else {
        preText = `<div class="directLink">Each of these links will start the study directly.</div>
            <div class="confirmLink">Each of these links will start the study but first ask the worker for confirmation (by pressing a button).</div>`;
        postText = `Copy & paste and hand them to your workers.`;
    }
    var warning;
    if (!batch.allowedWorkerTypes.includes(workerType)) {
        warning = `Worker type ${workerTypeUI} is currently not allowed in this batch`;
    }
    showStudyLinksDisplayModal(title, preText, studyCodes, postText, warning);
}

$('#batchTable').on('click', '.general-single-study-links-setup .studyLinkButton', function() {
    showStudyLinkGeneralSingleModal(getBatchData(this));
});

$('#batchTable').on('click', '.general-multiple-study-links-setup .studyLinkButton', function() {
    showStudyLinkGeneralMultipleModal(getBatchData(this));
});

function showStudyLinkGeneralSingleModal(batch) {
    $.ajax({
        url: `@{general.common.Common.getJatosUrlBasePath()}jatos/api/v1/studies/@{study.getId()}/studyCodes?batchId=${batch.id}&type=GeneralSingle`,
        success: function(studyCodeResponse) {
            var title = "Study link for worker type General Single in batch '" + batch.title + "'";
            var preText = `<div class="directLink">This link will start the study directly.</div>
                <div class="confirmLink">This link will start the study but first ask the worker for confirmation (by pressing a button).</div>`;
            var postText = `Or use the study code '${studyCodeResponse.data}'.<br>Copy & paste and hand it to your workers.`;
            var warning;
            if (!batch.allowedWorkerTypes.includes("@common.workers.GeneralSingleWorker.WORKER_TYPE")) {
                warning = `Worker type @common.workers.GeneralSingleWorker.UI_WORKER_TYPE is currently not allowed in this batch`;
            }
            showStudyLinksDisplayModal(title, preText, studyCodeResponse.data, postText, warning);
        },
        error : function(err) {
            showError(err.responseText);
        }
    });
}

function showStudyLinkGeneralMultipleModal(batch) {
    $.ajax({
        url: `@{general.common.Common.getJatosUrlBasePath()}jatos/api/v1/studies/@{study.getId()}/studyCodes?batchId=${batch.id}&type=GeneralMultiple`,
        success: function(studyCodeResponse) {
            var title = "Study link for worker type General Multiple in batch '" + batch.title + "'";
            var preText = `<div class="directLink">This link will start the study directly.</div>
                <div class="confirmLink">This link will start the study but first ask the worker for confirmation (by pressing a button).</div>`;
            var postText = `Or use the study code '${studyCodeResponse.data}'.<br>Copy & paste and hand it to your workers.`;
            var warning;
            if (!batch.allowedWorkerTypes.includes("@common.workers.GeneralMultipleWorker.WORKER_TYPE")) {
                warning = `Worker type @common.workers.GeneralMultipleWorker.UI_WORKER_TYPE is currently not allowed in this batch`;
            }
            showStudyLinksDisplayModal(title, preText, studyCodeResponse.data, postText, warning);
        },
        error : function(err) {
            showError(err.responseText);
        }
    });
}

function showStudyLinksDisplayModal(title, preText, studyCodes, postText, warning) {
    var htmlPreText =
        `<div class="btn-group btn-toggle">
            <button class="btn btn-xs btn-worker directLink active" data-toggle="tooltip" data-placement="bottom" title="Show links that start the study directly after clicking on them">Open Directly</button>
            <button class="btn btn-xs btn-default confirmLink" data-toggle="tooltip" data-placement="bottom" title="Show links that do not start the study directly but display a Study Entry page before. Here a message can be displayed (specified in Study Properites) and the worker has to click a button to start the study.">Confirm First</button>
        </div>
        <p>${preText}</p>`;
    var htmlUrl = '<div class="well linkUrls">' + generateStudyLinksHtml(studyCodes) + '</div>';

    removeAlerts("#studyLinksDisplayModal");
    if (warning) showWarning(warning, "#studyLinksDisplayModal .messages");

    var htmlPostText = `<p>${postText}</p>`;
    var content = htmlPreText + htmlUrl + htmlPostText;
    $('#studyLinksDisplayModal').find('.modal-title').text(title);
    $('#studyLinksDisplayModal').find('.content').html(content);
    $('#studyLinksDisplayModal div.confirmLink').addClass('hideKeepWidth');
    $('#studyLinksDisplayModal').modal('show');
    $('#studyLinksDisplayModal .btn-toggle').click(toggleDirectAndConfirmLink);
}

function generateStudyLinksHtml(studyCodes) {
    var directLinkUrls = studyCodes.map(l => `${getRealBaseUrl()}publix/${l}`);
    var confirmLinkUrls = studyCodes.map(l => `${getRealBaseUrl()}publix/run?code=${l}`);
    var qrButtonHtml = "";
    if (studyCodes.length == 1) {
        qrButtonHtml = `<button type="button" class="btn qrCodeButton btn-xs pull-right" data-toggle="tooltip" title="Show QR code for this link.">QR code&nbsp;<span class="glyphicon glyphicon-qrcode"></span></button>`;
    }
    var clipboardButtonHtml = `<button type="button" class="btn clipboardButton btn-xs pull-right" data-toggle="tooltip" title="Copy this link to the clipboard.">Copy&nbsp;<span class="glyphicon glyphicon-duplicate"></span></button>`;
    return `<div class="directLink"><span>${directLinkUrls.join('<br>\n')}</span>${qrButtonHtml}${clipboardButtonHtml}</div>
        <div class="confirmLink hideKeepWidth"><span>${confirmLinkUrls.join('<br>\n')}</span>${qrButtonHtml}${clipboardButtonHtml}</div>`;
}

$('#studyLinksDisplayModal, #studyLinksModal').on('click', '.clipboardButton', function(e) {
    var text = $(this).parent().find('span').text();
    copyToClipboard(text);
});

$('#studyLinksDisplayModal, #studyLinksModal').on('click', '.qrCodeButton', function(e) {
    var url = $(this).parent().find('span').text();
    showQRCode(url);
});

function showQRCode(url) {
    $('#qrcode').empty();
    $('#qrCodeModal').off('shown.bs.modal');
    $('#qrCodeModal .modal-title').text(`QR code for study link ${url}`);

    $('#qrCodeModal').on('shown.bs.modal', function (e) {
        let options = {
            text: url,
            correctLevel: QRCode.CorrectLevel.H
        };
        let qrcode = new QRCode(document.getElementById("qrcode"), options);

        // It's necessary to set the canvas size because EasyQRCodeJS does it wrong
        const width = $("#qrcode").width();
        $('#qrcode canvas').width(width);
        $('#qrcode canvas').height(width);

        const studyCode = url.slice(-11);
        const filename = `jatos-qr-studylink-${studyCode}`;
        $('#qrcode_download').click(() => qrcode.download(filename));
    });
    $('#qrCodeModal').modal('show');
}

$('#studyLinksModal .btn-toggle').click(toggleDirectAndConfirmLink);

// This function has to work in #studyLinksDisplayModal and #studyLinksModal
function toggleDirectAndConfirmLink(e) {
    e.stopPropagation();

    $(this).find('.btn').toggleClass('active');
    if ($(this).find('.btn-worker').length > 0) {
        $(this).find('.btn').toggleClass('btn-worker');
    }
    $(this).find('.btn').toggleClass('btn-default');

    if ($(this).find('button.directLink').hasClass('active')) {
        $(this).parents('.modal').find('div.directLink').removeClass('hideKeepWidth');
        $(this).parents('.modal').find('.linkUrls div.directLink button').addClass('pull-right');
        $(this).parents('.modal').find('div.confirmLink').addClass('hideKeepWidth');
        $(this).parents('.modal').find('.linkUrls div.confirmLink button').removeClass('pull-right');
    } else {
        $(this).parents('.modal').find('div.directLink').addClass('hideKeepWidth');
        $(this).parents('.modal').find('.linkUrls div.directLink button').removeClass('pull-right');
        $(this).parents('.modal').find('div.confirmLink').removeClass('hideKeepWidth');
        $(this).parents('.modal').find('.linkUrls div.confirmLink button').addClass('pull-right');
    }
}

$('#studyLinksModal').on('click', '.commentEditButton', function(e) {
    removeAlerts("#commentEditModal");
    removeFormErrors("#commentEditModal");
    clearForm("#commentEditModal");

    const tr = $(this).closest('tr');
    const rowData = studyLinksTable.row(tr).data();
    $('#commentEditModal').data('workerId', rowData.workerId);
    $('#commentEditModal .modal-title').text(`Edit comment of study code "${rowData.studyCode}"`);
    $('#commentEditModal #commentEditInput').val(rowData.comment);

    // Focus on comment input field in modal
    $('#commentEditModal').on('shown.bs.modal', function () {
        $('#commentEditInput').focus();
    })
    $('#commentEditModal').modal('show');
});

$("#commentEditModal form").submit(function(event) {
    event.preventDefault();
    const workerId = $('#commentEditModal').data('workerId');
    $.ajax({
        url: `@{general.common.Common.getJatosUrlBasePath()}jatos/worker/${workerId}/comment`,
        type : "POST",
        data : $('#commentEditModal form').serialize(),
        success: function() {
            $('#commentEditModal').modal('hide');
            studyLinksTable.ajax.reload();
        },
        error : function(err) {
            showError(err.responseText, "#commentEditModal .messages");
        }
    });
});

    function getBatchData(element) {
        let batchRow = $(element).closest('tr');
        if (!batchRow.hasClass('batch-row')) {
            batchRow = batchRow.prev()[0];
        }
        return $("#batchTable").DataTable().row(batchRow).data();
    }

</script>
