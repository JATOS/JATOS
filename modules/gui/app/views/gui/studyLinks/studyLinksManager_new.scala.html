@(signedinUser: common.User, study: common.Study)

@* Study link manager Modal (Personal Single or Personal Multiple) *@
<div class="modal fade" id="studyLinksManagerModal" tabindex="-1" data-bs-config='{"backdrop":"true", "focus":true, "keyboard":true}'>
    <div class="modal-dialog modal-xxl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Study Links</h5>
                <button type="button" class="btn btn-close btn-nav" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover w-100" id="studyLinksManagerTable">
                    <thead>
                        <tr>
                            <th class="no-info-icon" data-toggle="tooltip" title="Activate / inactivate this study link - only activated links can be used to run this study">Active<span class="info-icon"></span><span class="ordering-icon"></span></th>
                            <th class="no-info-icon" data-toggle="tooltip" title="ID of the worker that belongs to this study link">Worker&nbsp;ID<span class="info-icon"></span><span class="ordering-icon"></span></th>
                            <th class="no-info-icon" data-toggle="tooltip" title="This code, handed to workers, can be used in the /publix/run page to start the study.">Study&nbsp;Code<span class="info-icon"></span><span class="ordering-icon"></span></th>
                            <th>
                                <span class="align-bottom">Study Links</span>
                                <span class="btn-group btn-toggle ms-2">
                                    <button class="btn btn-xs btn-batch direct-link active mb-1" data-toggle="tooltip" title="Show links that start the study directly after clicking on them">Open Directly</button>
                                    <button class="btn btn-xs btn-outline-secondary confirm-link mb-1" data-toggle="tooltip" title="Show links that do not start the study directly but display a Study Entry page before. Here a message can be displayed (specified in Study Properites) and the worker has to click a button to start the study.">Confirm First</button>
                                </span>
                            </th>
                            <th class="no-info-icon" data-toggle="tooltip" title="Comment given during creation of study link">Comment<span class="info-icon"></span><span class="ordering-icon"></span></th>
                            <th class="no-info-icon" data-toggle="tooltip" title="State of the study result that belongs to this link. In case of a Personal Multiple link it's the state of the study result which study link was started last."><span class="state">Study&nbsp;Result&nbsp;State</span><span class="info-icon"></span><span class="ordering-icon"></span></th>
                            <th class="results no-info-icon" data-toggle="tooltip" title="">Study Results<span class="info-icon"></span></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

@* Study link display Modal *@
<div id="studyLinksDisplayModal" class="modal fade" data-backdrop="static" data-keyboard="true" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span><span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">Study link</h4>
            </div>
            <div class="modal-body">
                <div class="messages"></div>
                <div class="content"></div>
            </div>
        </div>
    </div>
</div>

@* Study link comment edit Modal (Personal Single or Personal Multiple) *@
<div class="modal fade" id="editCommentModal" tabindex="-1" data-bs-config='{"backdrop":"true", "focus":true, "keyboard":true}'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit comment of a study link</h5>
                <button type="button" class="btn btn-close btn-nav" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form class="form-batch" id="editCommentForm">
                    <div class="row">
                        <label class="col-sm-3 col-form-label" for="editCommentInput">Comment</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="editCommentInput" name="comment" placeholder="Your comment">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-batch" id="editCommentConfirmed">Save</button>
            </div>
        </div>
    </div>
</div>

<script @{helper.CSPNonce.attr} type="module">
    import * as Helpers from "@routes.Assets.versioned("lib/jatos-gui/javascripts/helpers.js")";
    import * as Alerts from "@routes.Assets.versioned("lib/jatos-gui/javascripts/alerts.js")";
    import * as WaitingModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/waitingModal.js")";
    import * as CopyToClipboard from "@routes.Assets.versioned("lib/jatos-gui/javascripts/copyToClipboard.js")";
    import * as FormValidation from "@routes.Assets.versioned("lib/jatos-gui/javascripts/formValidation.js")";
    import * as QrCodeModal from "@routes.Assets.versioned("lib/jatos-gui/javascripts/qrCodeModal.js")";

// todo "createdRow" callback
// todo responsive iphone SE layout

    const alerts = new Alerts.Named("study-links-manager");
    $("#studyLinksManagerModal, #editCommentModal").on('hide.bs.modal', alerts.hideAll);

    const paginationLength = 10;
    let studyLinksTable;

    $('#batchTable').on('click', '.study-links-manager', function(e) {
        const batch = getBatchData(this);
        const type = $(this).parents('.study-links-setup').data('type');
        const typeUI = Helpers.getWorkerTypeName(type);
        if (type === "PersonalSingle") {
            $('#studyLinksManagerModal th .state').text('Study Result State');
            $('#studyLinksManagerModal th.results').html('Study Result<span class="info-icon"></span>');
        } else if (type === "PersonalMultiple") {
            $('#studyLinksManagerModal th .state').text('Study Result State (latest)');
            $('#studyLinksManagerModal th.results').html('Study Results<span class="info-icon"></span>');
        } else {
            Alerts.error("Error showing study links manager: unknown type");
        }
        $('#studyLinksManagerModal .modal-title').text(`Study links for type '${typeUI}' in batch '${batch.title}'`);
        if (!batch.allowedWorkerTypes.includes(type)) {
            alerts.warning(`Type '${typeUI}' is currently not allowed in this batch.`);
        }
        fillStudyLinksTable(batch, type);
        $('#studyLinksManagerModal').data('batch', batch);
        $('#studyLinksManagerModal').data('type', type);
        $('#studyLinksManagerModal').modal('show');
    });

    function fillStudyLinksTable(batch, workerType) {
        studyLinksTable = $('#studyLinksManagerTable').DataTable({
            "ajax": {
                "url": window.routes.StudyLinks.studyLinksData(window.study.id, batch.id, workerType),
                "error": () => Alerts.error(`Couldn't load study links for type "${workerType}" in batch "${batch.title}".`)
            },
            "destroy": true,
            "dom": `<'d-flex flex-row flex-wrap justify-content-between align-items-center form-batch gap-1 mt-1 mb-3'Bfl>
                    rt
                    <'d-flex flex-row flex-wrap justify-content-between align-items-center gap-1 mt-3'ip>`,
            "pageLength": paginationLength,
            "pagingType": "full_numbers",
            "stateSave": true,
            "stateSaveParams": function (settings, data) {
                data.search.search = "";
            },
            "order": [[ 1, "desc" ]],
            "scrollX": true,
            "columns": [
                {
                    "className": "link-active",
                    "data": null,
                    "width": "1%",
                    "render": (data, type, full, meta) => {
                        if (workerType === "PersonalSingle" && full.studyResultState !== null && full.studyResultState !== "PRE") {
                            return '<span class="used" data-toggle="tooltip" title="This link was already used.">used</span>';
                        } else {
                            return `
                                <label class="switch no-info-icon align-middle" data-toggle="tooltip" title="Use this switch to de-/activate this study link.">
                                    <input type="checkbox" ${full.active ? "checked" : ""}>
                                    <span class="slider slider-batch round"></span>
                                </label>`;
                        }
                    }
                },
                {
                    "data": "workerId",
                },
                {
                    "data": "studyCode",
                    "render": function(studyCode, type, row) {
                        return `
                            <div class="text-nowrap">
                                <span>${studyCode}</span>
                                <span class="btn-clipboard no-info-icon" data-toggle="tooltip" title="Copy to clipboard"></span>
                            </div>`;
                    }
                },
                {
                    "data": "studyCode",
                    "orderable": false,
                    "render": renderStudyLink
                },
                {
                    "data": "comment",
                    "render": function (data, type, full, meta) {
                        const comment = data ? data : '<span class="text-body text-opacity-50">none</span>';
                        return `<span class="btn-edit edit-comment no-info-icon" data-toggle="tooltip" title="Edit this comment by clicking on it">
                            ${comment}</span>`;
                    }
                },
                {
                    "data": "studyResultState",
                    "render": (d) => d ? d : '<span class="text-body text-opacity-50">not yet</span>'
                },
                {
                    "data": null,
                    "orderable": false,
                    "width": "1%",
                    "render": renderWorkerResultsButton
                }
            ],
            "createdRow": function(row, data, index) {
                //renderColumnActive($(row).find('.activeStudyLinkButton'), data.active, data.studyResultState);
            },
            "buttons": [
                {
                    "text": '<i class="bi-plus-lg fw-bold pe-1"></i><i class="bi-link-45deg"></i>',
                    "attr":  {
                        "id": "oneNewStudyLinkButton"
                    },
                    "className": "btn btn-batch",
                    "titleAttr": 'Shortcut to create just one study link without comment'
                },
                {
                    "text": '<i class="bi-plus-lg fw-bold pe-1"></i>New Study Links<i class="bi-link-45deg ps-1"></i>',
                    "attr":  {
                        "id": "newStudyLinksButton"
                    },
                    "className": "btn btn-batch",
                    "titleAttr": 'Create new study links'
                },
                {
                    "text": '<i class="bi-arrow-repeat"></i>',
                    "attr":  {
                        "id": "refreshButton"
                    },
                    "className": "btn btn-batch",
                    "titleAttr": 'Refresh the table',
                    action: function(e, dt, node, config) {
                        this.disable();
                        studyLinksTable.ajax.reload();
                        setTimeout(this.enable, 3000);
                    }
                }
            ],
            language: {
                "lengthMenu": "_MENU_",
                "search": "Search:",
                "paginate": {
                    "first": `<i class="bi-chevron-double-left"></i>`,
                    "previous": `<i class="bi-chevron-left"></i>`,
                    "next": `<i class="bi-chevron-right"></i>`,
                    "last": `<i class="bi-chevron-double-right"></i>`
                },
                "emptyTable": "No links yet",
            },
            "initComplete": function(settings, json) {
                generateShowButtonGroup();
                $(".dt-buttons").not("#studyLinksTable_show").removeClass("btn-group");
            },
            "drawCallback": function( settings ) {
                setWorkerResultsButtonWidthToMax();
                showDirectOrConfirmStudyLink();
                //toggleTablePagination();
                $(".dt-length select").removeClass("form-select-sm");
                $(".dt-search input").removeClass("form-control-sm");
            }
        });

        function generateShowButtonGroup() {
            new $.fn.dataTable.Buttons(studyLinksTable, {
                    "name": "showButtonGroup",
                    "className": "ms-2",
                    "buttons": [
                        {
                            "text": "All",
                            "className": "btn-batch",
                            "init": (dt, node, config) => node.removeClass("btn-secondary"),
                            "titleAttr": 'Show all study links',
                            "action": function(e, dt, node, config) {
                                dt.column(0).search("").draw();
                            }
                        },
                        {
                            "text": "Active",
                            "className": "btn-outline-secondary",
                            "init": (dt, node, config) => node.removeClass("btn-secondary"),
                            "titleAttr": 'Show only active study links',
                            "action": (e, dt, node, config) => dt.column(0).search((str, data, idx) => data.active).draw()
                        },
                        {
                            "text": "Deactivated",
                            "className": "btn-outline-secondary",
                            "init": (dt, node, config) => node.removeClass("btn-secondary"),
                            "titleAttr": 'Show only deactivated study links',
                            "action": (e, dt, node, config) => dt.column(0).search((str, data, idx) => !data.active).draw()
                        },
                        {
                            "text": "Used",
                            "className": "btn-outline-secondary",
                            "init": (dt, node, config) => node.removeClass("btn-secondary"),
                            "titleAttr": 'Show only study links that were already used by a participant. Only for link type Personal Single.',
                            "action": function(e, dt, node, config) {
                                const workerType = $('#studyLinksManagerModal').data('type');
                                dt.column(0).search((str, data, idx) =>
                                    workerType === "PersonalSingle"
                                    && data.studyResultState !== null
                                    && data.studyResultState !== "PRE"
                                ).draw();
                            }
                        }
                    ]
            });
            studyLinksTable.buttons('showButtonGroup', null).containers()
                    .attr('id', 'studyLinksTable_show')
                    .prependTo('.dt-length');
            $('<label for="studyLinksTable_show" class="me-2">Show:</label>').prependTo('.dt-length');

            $('#studyLinksTable_show').on('click', 'button', function() {
                $(this).parent().children('button').each((i, button) => {
                    $(button).removeClass('btn-batch').addClass('btn-outline-secondary');
                });
                $(this).removeClass('btn-outline-secondary').addClass('btn-batch');
            });
        }

        function renderStudyLink(studyCode, type, row) {
            return `
                <div class="direct-link text-nowrap">
                    <span>${window.routes.Publix.run(studyCode)}</span>
                    <span class="btn-clipboard no-info-icon" data-toggle="tooltip" title="Copy this link to the clipboard."></span>
                    <span class="btn-qr-code no-info-icon" data-toggle="tooltip" title="Show QR code for this link."></span>
                </div>
                <div class="confirm-link text-nowrap">
                    <span>${window.routes.Publix.studyEntry(studyCode)}</span>
                    <span class="btn-clipboard no-info-icon" data-toggle="tooltip" title="Copy this link to the clipboard."></span>
                    <span class="btn-qr-code no-info-icon" data-toggle="tooltip" title="Show QR code for this link."></span>
                </div>`;
        }

        function renderWorkerResultsButton(data, type, full) {
            const workerType = $('#studyLinksManagerModal').data('type');
            const name = workerType === "PersonalMultiple" ? "Results" : "Result";
            const count = workerType === "PersonalMultiple" ? full.studyResultCount : "";
            const hideBadge = workerType === "PersonalSingle";
            const button = `
                <a type="button" class="btn btn-batch btn-sm worker-results-button no-info-icon text-nowrap"
                    data-toggle="tooltip" title="Shows study results of this study link"
                    href="${window.routes.StudyResults.workersStudyResults(full.workerId)}">
                    ${name}
                    <span class="badge text-batch bg-white rounded-pill no-info-icon ms-1 ${hideBadge ? "d-none" : ""}"
                        data-toggle="tooltip" title="Number of study results that belong to this study link">
                        ${count}
                    </span>
                </a>`;
            return full.studyResultState !== null ? button : '<span class="text-body text-opacity-50">none</span>';
        }

        function setWorkerResultsButtonWidthToMax() {
            // That's an ugly hack: just using datatables "drawCallback" doesn't work. For some reason the
            // buttons have an width of near 0. Here we wait until the first button has a width of > 1 and
            // only then trigger the button resizing.
            var buttons = $("#studyLinksManagerTable .worker-results-button");
            if (!(buttons && buttons.length && $(buttons[0]).width() > 1)) {
                window.requestAnimationFrame(setWorkerResultsButtonWidthToMax);
            } else {
                Helpers.setButtonWidthToMax("#studyLinksManagerTable .worker-results-button");
                studyLinksTable.columns.adjust();
            }
        };

        function showDirectOrConfirmStudyLink() {
            if ($('th button.direct-link').hasClass('active')) {
                $('td div.direct-link').removeClass('hide-keep-width');
                $('td div.confirm-link').addClass('hide-keep-width');
            } else {
                $('td div.direct-link').addClass('hide-keep-width');
                $('td div.confirm-link').removeClass('hide-keep-width');
            }
        }

        function toggleTablePagination() {
            var rowNumber = studyLinksTable.rows().count();
            var hidePaging = rowNumber <= paginationLength;
            $('#studyLinksManagerTable .dataTables_paginate').toggle(!hidePaging);
        }
    }

    $('#studyLinksManagerModal').on('click', '#newStudyLinksButton', function(e) {
        $('#studyLinksCreatorModal').modal('show');
    });

    $('#studyLinksManagerModal').on('click', '#oneNewStudyLinkButton', function(e) {
        const batch = $('#studyLinksManagerModal').data('batch');
        const type = $('#studyLinksManagerModal').data('type');
        $.ajax({
            url: window.routes.Api.getStudyCodes(window.study.id, batch.id, type, "", 1),
            success: () => studyLinksTable.ajax.reload(),
            error : (err) => alerts.error(err.responseText)
        });
    });

    $('#studyLinksManagerModal').on('click', '.refreshButton', function(e) {
        this.disable();
        studyLinksTable.ajax.reload();
        setTimeout(this.enable, 3000);
    });

    $('#studyLinksManagerModal').on('click', '.btn-clipboard', CopyToClipboard.onClick);

    $('#studyLinksManagerModal').on('click', '.btn-qr-code', function(e) {
        var url = $(this).parent().find('span').text();
        QrCodeModal.show(url, `This is the QR code for the study link <i>${url}</i>.`);
    });

    $('#studyLinksManagerModal').on('click', '.link-active input', function(e) {
        e.preventDefault();
        const checkbox = this;
        const batch = $('#studyLinksManagerModal').data('batch');
        const active = $(checkbox).is(':checked');
        const tr = $(checkbox).closest('tr');
        const linkData = studyLinksTable.row(tr).data();
        $.ajax({
            url: window.routes.StudyLinks.toggleStudyLinkActive(window.study.id, batch.id, linkData.studyCode, active),
            type: "POST",
            success: function(active) {
                linkData.active = active;
                $(checkbox).prop('checked', linkData.active);
            },
            error: () => alerts.error(err.responseText)
        });
    });

    $('#studyLinksManagerModal .btn-toggle').click(toggleDirectAndConfirmLink);

    // This function has to work in #studyLinksDisplayModal and #studyLinksManagerModal
    function toggleDirectAndConfirmLink(e) {
        e.stopPropagation();

        $(this).find('.btn').toggleClass('active');
        if ($(this).find('.btn-batch').length > 0) {
            $(this).find('.btn').toggleClass('btn-batch');
        }
        $(this).find('.btn').toggleClass('btn-outline-secondary');

        if ($(this).find('button.direct-link').hasClass('active')) {
            $(this).parents('.modal').find('div.direct-link').removeClass('hide-keep-width');
            $(this).parents('.modal').find('.linkUrls div.direct-link button').addClass('float-end');
            $(this).parents('.modal').find('div.confirm-link').addClass('hide-keep-width');
            $(this).parents('.modal').find('.linkUrls div.confirm-link button').removeClass('float-end');
        } else {
            $(this).parents('.modal').find('div.direct-link').addClass('hide-keep-width');
            $(this).parents('.modal').find('.linkUrls div.direct-link button').removeClass('float-end');
            $(this).parents('.modal').find('div.confirm-link').removeClass('hide-keep-width');
            $(this).parents('.modal').find('.linkUrls div.confirm-link button').addClass('float-end');
        }
    }

    $('#studyLinksManagerModal').on('click', '.edit-comment', function(e) {
        $("#editCommentForm")[0].reset();
        FormValidation.clear("#editCommentForm");

        const tr = $(this).closest('tr');
        const linkData = studyLinksTable.row(tr).data();
        $('#editCommentModal .modal-title').text(`Edit comment of the study link with code "${linkData.studyCode}"`);
        $('#editCommentModal #editCommentInput').val(linkData.comment);

        $('#editCommentModal').data('workerId', linkData.workerId);
        $('#editCommentModal').modal('show');
    });

    $("#editCommentConfirmed").click(function(event) {
        const workerId = $('#editCommentModal').data('workerId');
        $.ajax({
            url: window.routes.StudyLinks.editWorkerComment(workerId),
            type : "POST",
            data : $('#editCommentForm').serialize(),
            success: function() {
                $('#editCommentModal').modal('hide');
                studyLinksTable.ajax.reload();
            },
            error : function(err) {
                FormValidation.show("#editCommentForm", {comment: [err.responseText]});
            }
        });
    });

    function getBatchData(element) {
        let row = $(element).closest('tr');
        if (!row.hasClass('batch-row')) {
            row = row.prev()[0];
        }
        return $("#batchTable").DataTable().row(row).data();
    }

</script>
